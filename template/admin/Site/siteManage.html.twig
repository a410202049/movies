{% extends "admin/Common/iframe_common.html.twig" %}
{% block container %}
<body class="gray-bg">
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>站点列表</h5>
                    </div>
                    <div class="ibox-content container-fluid">
                    	<form action="{{base_url('admin/Site/siteManage/1')}}">
	                        <div class="row col-md-12">
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">站点名称/域名</label>
	                        		<input type="text" class="form-control" name="site_keywords" id="site_keywords" value="{{getArr.site_keywords}}">
	                        	</div>
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">站点状态</label>
	                        		<select class="form-control" name="site_status">
	                        			<option value="-1" {% if getArr.site_status == '-1' %}selected=selected{% endif %}>所有</option>
	                        			<option value="1" {% if getArr.site_status == '1' %}selected=selected{% endif %}>启用</option>
	                        			<option value="0" {% if getArr.site_status == '0' %}selected=selected{% endif %}>禁用</option>
	                        		</select>
	                        	</div>
	                            <div class="col-md-3 form-group">
	                            	<label for="null" class="center-block">&nbsp;</label>
	                            	<button type="submit" class="btn btn-primary" id="search-btn"><i class="fa fa-search"></i>&nbsp;查询</button>
	    							<button type="button" class="btn btn-primary add-site"><i class="fa fa-plus"></i>&nbsp;新增站点
	    							</button>
	                            </div>
	                        </div>
                        </form>
                        <div class="table-responsive col-md-12">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>            
                                    	<th>id</th>                         
                                        <th>站点名称</th>
                                        <th>站点域名</th>
                                        <th>站点状态</th>
                                        <th>创建时间</th>
                                        <th>备注</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for site in sites %}
                                    <tr>
                                    	<td>
                                    		{{site.id}}
                                    	</td>
                                        <td>
	                                        {{site.site_alias}}
                                        </td>
                                        <td>
                                        	{% if site.site_domain is iterable %}
											    {% for domains in site.site_domain %}
											        <a href="{{domains.domain}}" target="_blank">{{domains.domain}}</a>
											        {% if not loop.last %}
															,
											        {% endif %}
											    {% endfor %}
											{% else %}
											    <a href="{{site.site_domain}}" target="_blank">{{site.site_domain}}</a>
											{% endif %}
                                        </td>
                                    	<td>
                                            {% if site.site_status==1 %}
                                                <span for="" class="label label-primary">
                                                    Enable
                                                </span>
                                            {% elseif site.site_status==0 %}
                                                <span for="" class="label label-danger">
                                                    Disable
                                                </span>
                                            {% elseif site.site_status==2 %}
                                                <span for="" class="label label-danger">
                                                    Forbidden
                                                </span>                                                
                                                {% else %}
                                                <span for="" class="label label-default">
                                                    Unknown
                                                </span>        
                                            {% endif %}
                                        </td>
                                        <td><time>{{site.create_time}}</time></td>
                                        <td>
                                            <span class="tooltip-content" data-toggle="tooltip" data-original-title="{{site.remark}}" data-placement="bottom">{{site.remark|slice(0,15)}}</span>
                                        </td>
     
                                        <td>
	                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary edit-site" data-id="{{site.id}}" title="编辑"><i class="fa fa-edit"></i></a>
	                                        {% if site.site_status==1 %}
	                                        	<a href="javascript:void(0)" class="btn btn-sm btn-danger status-btn" data-id="{{site.id}}" title="禁用"><i class="fa fa-times"></i></a>
                                            {% else %}
	                                        	<a href="javascript:void(0)" class="btn btn-sm btn-primary status-btn" data-id="{{site.id}}" title="启用"><i class="fa fa-check"></i></a>	                                        	      
                                            {% endif %}                                         
                                            <a target="_blank" href="{{base_url('siteAdmin/SiteManage/index')}}?siteid={{site.id}}" class="btn btn-sm btn-success" data-id="{{site.id}}" title="主页"><i class="fa fa-home"></i></a>

                                        </td>
                                    </tr>
                                 {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="fixed-table-pagination col-md-12">
                        	<div class="pull-left pagination-detail">
                        		<span class="pagination-info">共<strong>{{pager.total}}</strong>条记录&nbsp;<strong>{{pager.nowindex}}/{{pager.totalpage}}</strong>页</span>
                    		</div>
                            {% autoescape true %}  
                             {{pager.show(1)|raw }}
                            {% endautoescape %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}
{% block script %}
<script>
	jQuery(document).ready(function($) {
		$('.tooltip-content').tooltip()
		$('.add-site').click(function(){
			$.ajax({
				url: '{{base_url("admin/Site/getLanguage")}}',
				type: 'GET',
    			dataType: 'json',
				async:false
			})
			.done(function(data) {
				var langs = data.data;
				var options = "";
				for(var i in langs){
					options += '<option value="'+langs[i].id+'">'+langs[i].code+'</option>';
				}
	    		layer.open({
				  type: 1,
				  closeBtn:2,
				  title:'新增站点',
				  shadeClose: true, //开启遮罩关闭
				  area: ['800px', '85%'],
				  content: 
				  '<div class="ibox-content">'+
				  '<form class="form-horizontal">'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">站点名称:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" class="form-control" id="add-sitename" placeholder="1位以上中英文,下划线">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">多语言切换:</label>'+
			             	'<div class="col-sm-8 btn-group" id="multi_lang_type">'+
			                    '<button type="button" class="btn btn-white btn-toggle active" data-value="1">Cookie</button>'+
			                    '<button type="button" class="btn btn-white btn-toggle" data-value="2">域名</button>'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must domain-container">'+
			            '<label class="col-sm-3 control-label">域名:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" id="add-domain" class="form-control domain-input" placeholder="http://">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            	'<label class="col-sm-3 control-label">语言:</label>'+
			             	'<div class="col-sm-8">'+
								'<select class="form-control" style="width:100%" id="add-lang" multiple=multiple>'+
										options+
								'</select>'+
			                '</div>'+
			            '</div>'+	
			            '<div class="form-group">'+
			            '	<label class="col-sm-3 control-label">管理员:</label>'+
			             	'<div class="col-sm-8">'+
								'<select class="form-control" style="width:100%" id="add-admin" multiple=multiple>'+
								
								'</select>'+
			                '</div>'+
			            '</div>'+	            
			            '<div class="form-group">'+
			            '<label class="col-sm-3 control-label">备注:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<textarea type="text" rows="4" autocomplete="off" id="add-remark" class="form-control" placeholder="备注..."></textarea>'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group">'+
			            '<label class="col-sm-3 control-label">统计代码:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<textarea type="text" rows="4" autocomplete="off" id="add-statistic" class="form-control" placeholder="统计代码"></textarea>'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group">'+
			                '<div class="col-sm-offset-3 col-sm-8">'+
			                    '<span class="btn btn-primary" id="add-site">添加</span>'+
			                '</div>'+
			            '</div>'+
		        	'</form></div>',
		        	success:function(){
		        		$("#add-admin").select2({
						  ajax: {
						    url: "{{base_url('admin/Site/getUserJson')}}",
						    type:'GET',
						    dataType: 'json',
						    delay: 250,
						    data: function (params) {
						      return {
						        "username": params.term, // search term
						      };
						    },
						    processResults: function (data, params) {
						      return {
						        results:data.data,
						      }
						    },
						    cache: false
						  },
						  escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
						  minimumInputLength: 1,
						  templateResult:function(re){
						  	if(re.loading) return "Loading..."
						  	return ('<strong>'+re.realname+'</strong> -'+re.email)
						  },
						  templateSelection:function(re){
						  	return(re.email)
						  }
						  
						});
		        		$("#add-lang").select2();					
		        	}
				});
			})
			.fail(function(e){
				common.ajaxError(e)
			})

    	});
    	$('.edit-site').click(function(){
    		var $this = $(this);
    		var site;
    		var langs = [];
    		$.ajax({
				url: '{{base_url("admin/Site/getLanguage")}}',
				type: 'GET',
    			dataType: 'json',
				async:false
			})
			.done(function(e){
				if (e.status!=1) {
		   			common.ajaxError(e);
		   			return false;
		   		}
		   		for(var i in e.data){
		   			langs.push({id:e.data[i].id,text:e.data[i].code})
		   		}
		   	

			})
    		$.ajax({
    			url: '{{base_url("admin/Site/getSiteInfo")}}',
    			type: 'POST',
    			dataType: 'json',
    			data: {sid: $this.attr('data-id')},
    			timeout:4000,
    			async:false
    		})
    		.done(function(data) {
    			if(data.status==1){
    				site = (data.data)
    			}else{
    				common.ajaxError(data)
    			}

    		})
    		.fail(function(e) {
    			common.ajaxError(e);
    		})
    		var domHTML = '';
        		domHTML='<div class="ibox-content">'+
				  '<form class="form-horizontal">'+
			            '<div class="form-group must">'+
			           '<label class="col-sm-3 control-label">站点名称:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" class="form-control" id="edit-sitename" placeholder="1位以上中英文,下划线" value="'+site.site_alias+'">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">多语言切换:</label>'+
			             	'<div class="col-sm-8 btn-group" id="multi_lang_type">'+
			                    '<button type="button" class="btn btn-white btn-toggle active" data-value="1">Cookie</button>'+
			                    '<button type="button" class="btn btn-white btn-toggle" data-value="2">域名</button>'+
			                '</div>'+
			            '</div>'+			            
			            '<div class="form-group must domain-container">'+
			            '<label class="col-sm-3 control-label">域名:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" id="edit-domain" class="form-control domain-input" placeholder="http://" value="'+site.site_domain+'">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            	'<label class="col-sm-3 control-label">语言:</label>'+
			             	'<div class="col-sm-8">'+
								'<select class="form-control" style="width:100%" id="edit-lang" multiple=multiple>';
								// for(var i in site.lang_list){
								// 	domHTML+='<option selected value="'+site.lang_list[i].id+'">'+site.lang_list[i].code+'</option>';
								// }
										
								domHTML+='</select>'+
			                '</div>'+
			            '</div>'+	
			            '<div class="form-group">'+
			            '	<label class="col-sm-3 control-label">管理员:</label>'+
			             	'<div class="col-sm-8">'+
								'<select class="form-control" style="width:100%" id="edit-admin" multiple=multiple>'+
								
								'</select>'+
			                '</div>'+
			            '</div>'+	            
			            '<div class="form-group">'+
			            '<label class="col-sm-3 control-label">备注:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<textarea type="text" rows="4" value="'+site.remark+'" autocomplete="off" id="edit-remark" class="form-control" placeholder="备注...">'+site.remark+'</textarea>'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group">'+
			            '<label class="col-sm-3 control-label">统计代码:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<textarea type="text" rows="4" autocomplete="off" value="'+site.statistical_code+'" id="edit-statistic" class="form-control" placeholder="统计代码">'+site.statistical_code+'</textarea>'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group">'+
			                '<div class="col-sm-offset-3 col-sm-8">'+
			                    '<span class="btn btn-primary" data-id="'+site.id+'" id="edit-site">修改</span>'+
			                '</div>'+
			            '</div>'+
			        	'</form></div>';
				layer.open({
				  type: 1,
				  closeBtn:2,
				  title:'编辑站点',
				  shadeClose: true, //开启遮罩关闭
				  area: ['800px', '80%'],
				  content:domHTML,
				  success:function(){
					  	$('#multi_lang_type .btn-toggle[data-value="'+site.multi_lang_type+'"]').click()
				  		$('#edit-lang').select2({
				  			data:langs,
				  			templateResult:function(re){
						  	return (re.id+'-'+re.text)
						  },
						  templateSelection:function(re){
						  	return(re.text)
						  },
				  		})
						$("#edit-admin").select2({
  						  ajax: {
						    url: "{{base_url('admin/Site/getUserJson')}}",
						    type:'GET',
						    dataType: 'json',
						    delay: 250,
						    data: function (params) {
						      return {
						        "username": params.term, // search term
						      };
						    },
						    processResults: function (data, params) {
						      return {
						        results:data.data,
						      }
						    },
						    cache: false
						  },
						  escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
						  minimumInputLength: 1,
						  templateResult:function(re){
						  	if(re.loading) return "Loading..."
						  	return ('<strong>'+re.realname+'</strong> -'+re.email)
						  },
						  templateSelection:function(re){
						  	return(re.email||re.text)
						  }
						});
						var $option = [];
						for(var i in site.lang_list){
							$option.push(site.lang_list[i].id);
						}
						$("#edit-lang").val($option).trigger('change');
						for(var i in site.users){
							var $option = $('<option selected >'+site.users[i].email+'</option>').val(site.users[i].id);
							$("#edit-admin").append($option).trigger('change');
						}

					}
				});
    	})	
		$(document).on('click','.admin-list',function(){
			var id = $(this).data("id")
			$.get('{{base_url("admin/Site/getAdmin")}}', function(data) {
				
			});
		});
		$(document).on("click", "#add-site", function(){
		   var data = {
		   		site_alias:$("#add-sitename").val(),
		   		site_admin:$('#add-admin').val(),
		   		site_lang:$('#add-lang').val(),
		   		remark:$('#add-remark').val(),
		   		multi_lang_type:$('#multi_lang_type .active').data("value"),
		   		statistical_code:$('#add-statistic').val(),
		   		type:"add",
		   }
		   if(data.multi_lang_type == 1){
		   		data.site_domain = $('#add-domain').val()
		   }
		   $.ajax({
			   	url: '{{base_url("admin/Site/editSite")}}',
			   	type: 'POST',
			   	dataType: 'json',
			   	timeout:4000,
			   	data: {
			   		siteInfo:JSON.stringify(data)
			   	},
			   	beforeSend:function(){
			   		layer.load(2);
			   	}
		   })
		   .done(function(e) {
		   		if (e.status!=1) {
		   			common.ajaxError(e);
		   			return false;
		   		}
		   		layer.closeAll();
		   		window.location.href = window.location.href;
		   		parent.layer.msg(e.message,{
		   			icon:1
		   		});
		   })
		   .fail(function(e) {
		   		common.ajaxError(e)
		   })
		   .always(function() {
			   	layer.closeAll('loading');
		   });
		   
		});
		$(document).on("click", "#edit-site", function(){
		   var data = {
			   	site_id:$(this).attr('data-id'),
		   		site_alias:$("#edit-sitename").val(),
		   		site_domain:$('#edit-domain').val(),
		   		site_lang:$('#edit-lang').val(),
		   		remark:$('#edit-remark').val(),
		   		site_admin:$('#edit-admin').val(),
		   		multi_lang_type:$('#multi_lang_type .active').data("value"),
		   		statistical_code:$('#edit-statistic').val(),
		   		type:"edit",
		   }
		   if(data.multi_lang_type == 1){
		   		data.site_domain = $('#edit-domain').val()
		   }		   
		   $.ajax({
			   	url: '{{base_url("admin/Site/editSite")}}',
			   	type: 'POST',
			   	dataType: 'json',
			   	timeout:4000,
			   	data: {
			   		siteInfo:JSON.stringify(data)
			   	},
			   	beforeSend:function(){
			   		layer.load(2);
			   	}
		   })
		   .done(function(e) {	
		   		if (e.status!=1) {
		   			common.ajaxError(e);
		   			return false;
		   		}
		   		layer.closeAll();
		   		window.location.href = window.location.href;
		   		parent.layer.msg(e.message,{
		   			icon:1
		   		});
		   })
		   .fail(function(e) {
		   		common.ajaxError(e)
		   })
		   .always(function() {
			   	layer.closeAll('loading');
		   });
		   
		});		
    	$(document).on('click','.status-btn',function(e){
    		var $this = $(this);
    		var id = $(this).attr("data-id");
    		var index = $(this).parent().index()-3
    		if(id==""||id==null)return false;
    		$.ajax({
    			url: '{{base_url("admin/Site/siteEnable")}}',
    			type: 'POST',
    			dataType: 'json',
    			data: {'sid': id},
    			timeout:4000,
			   	beforeSend:function(){
			   		layer.load(2);
			   	}
    		})
    		.done(function(e) {
		   		if (e.status!=1) {
		   			common.ajaxError(e);
		   			return false;
		   		}
		   		layer.closeAll();
		   		$this.parent().parent().find('td').eq(index).html('<span for="" class="label label-'+{"1":"primary","0":"danger",'2':'danger'}[e.data]+'">'+{"1":"Enable","0":"Disable",'2':"Forbidden"}[e.data]+'</span>')
		   		$this.removeClass('btn-danger btn-primary').addClass({"1":"btn-danger","0":"btn-primary","2":"btn-primary"}[e.data])
		   		$this.attr('title',{"1":"禁用","0":"启用",'2':'启用'}[e.data]).html('<i class="fa fa-'+{"1":"times","0":"check",'2':"check"}[e.data]+'"></i>');
		   		layer.tips(e.message,$this,{
		   			tips:[2,"#1ab394"]
		   		})

    		})
			.fail(function(e) {
				common.ajaxError(e)
			})
			.always(function() {
			   	layer.closeAll('loading');
			});
    	})
    	$(document).on('click', '#multi_lang_type .btn-toggle', function(event) {
    		var val = $(this).data("value");
    		if(val == 1){
    			$('.domain-container').show();
    		}
    		if(val == 2){
    			$('.domain-container').hide();
    		}
    	});
	});
</script>
{% endblock %}