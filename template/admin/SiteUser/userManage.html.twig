{% extends "admin/Common/iframe_common.html.twig" %}
{% block container %}
<body class="gray-bg">
    <div class="wrapper wrapper-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>用户列表</h5>
                    </div>
                    <div class="ibox-content container-fluid">
                    	<form action="{{base_url('admin/SiteUser/userManage/1')}}">
	                        <div class="row col-md-12">
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">邮箱/真实姓名</label>
	                        		<input type="text" class="form-control" name="account" id="search-username" value="{{getArr.account}}">
	                        	</div>
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">用户类型</label>
	                        		<select class="form-control" name="user_type">
	                        			<option value="-1" {% if getArr.user_type == '-1' %}selected=selected{% endif %}>所有</option>
	                        			<option value="1" {% if getArr.user_type == '1' %}selected=selected{% endif %}>平台管理员</option>
	                        			<option value="2" {% if getArr.user_type == '2' %}selected=selected{% endif %}>站点管理员</option>
	                        		</select>
	                        	</div>
	                        	<div class="col-md-3 form-group">
	                        		<label for="search-username">用户状态</label>
	                        		<select class="form-control" name="status">
	                        			<option value="-1" {% if getArr.status == '-1' %}selected=selected{% endif %}>所有</option>
	                        			<option value="1" {% if getArr.status == '1' %}selected=selected{% endif %}>启用</option>
	                        			<option value="0" {% if getArr.status == '0' %}selected=selected{% endif %}>禁用</option>
	                        		</select>
	                        	</div>
	                            <div class="col-md-3 form-group">
	                            	<label for="null" class="center-block">&nbsp;</label>
	                            	<button type="submit" class="btn btn-primary" id="search-btn"><i class="fa fa-search"></i>查询</button>
	    							<button type="button" class="btn btn-primary add-user"><i class="fa fa-plus"></i>&nbsp;添加用户
	    							</button>
	                            </div>
	                        </div>
                        </form>
                        <div class="table-responsive col-md-12">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>                                     
                                        <th>真实姓名</th>
                                        <th>邮箱</th>
                                        <th>用户类型</th>
                                        <th>拥有站点</th>
                                        <th>状态</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for user in users %}
                                    <tr>
                                        <td>
	                                        {{user.realname}}
                                        </td>
                                        <td>
                                        	{{user.email}}
                                        </td>
                                        <td>
                                        	{% if user.user_type==1%}
                                        		平台管理员
                                        		{% elseif user.user_type==2 %}
                                        		站点管理员
	                                        {% endif %}
                                        </td>
                                        <td>
                                            {% for site in user.sites %} 
                                                <a class="text-navy" target="_blank" href="{{base_url('siteAdmin/SiteManage/index')}}?siteid={{site.id}}">{{site.site_alias}}</a>
                                                {% if not loop.last %}
                                                    ,
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                        	{% if user.status==1 %}
	                                        	<span for="" class="label label-primary">
	                                        		Enable
	                                        	</span>
                                            {% elseif user.status==0 %}
	                                        	<span for="" class="label label-danger">
	                                        		Disable
	                                        	</span>
	                                            {% else %}
	                                        	<span for="" class="label label-default">
	                                        		Unknown
	                                        	</span>        
                                            {% endif %}


                                        </td>
                                        <td>
	                                        <a href="javascript:void(0)" class="btn btn-sm btn-primary edit-btn" data-id="{{user.id}}" title="编辑"><i class="fa fa-edit"></i></a>
	                                        {% if user.status==1 %}
	                                        	<a href="javascript:void(0)" class="btn btn-sm btn-danger status-btn" data-id="{{user.id}}" title="禁用"><i class="fa fa-times"></i></a>
                                            {% else %}
	                                        	<a href="javascript:void(0)" class="btn btn-sm btn-primary status-btn" data-id="{{user.id}}" title="启用"><i class="fa fa-check"></i></a>	                                        	      
                                            {% endif %}

                                        </td>
                                    </tr>
                                 {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="fixed-table-pagination col-md-12">
                        	<div class="pull-left pagination-detail">
                        		<span class="pagination-info">共<strong>{{pager.total}}</strong>条记录&nbsp;<strong>{{pager.nowindex}}/{{pager.totalpage}}</strong>页</span>
                    		</div>
                            {% autoescape true %}  
                             {{pager.show(1)|raw }}
                            {% endautoescape %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
{% endblock %}
{% block script %}
    <script>
        $(document).ready(function(){
        	$('.add-user').click(function(){
        		layer.open({
				  type: 1,
				  closeBtn:2,
				  title:'添加用户',
				  shadeClose: true, //开启遮罩关闭
				  area: ['600px', 'auto'],
				  content: 
				  '<div class="ibox-content">'+
				  '<form class="form-horizontal">'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">邮箱:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="email" autocomplete="off" class="form-control" id="add-email" placeholder="邮箱">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">真实姓名:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" id="add-realname" class="form-control" placeholder="真实姓名">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group">'+
			                '<label class="col-sm-3 control-label">用户类型:</label>'+
			                '<div class="btn-group col-sm-8" id="add-usertype">'+
			                    '<button type="button" class="btn btn-toggle btn-white active" data-type="2">站点管理员</button>'+
			                    '<button type="button" class="btn btn-toggle btn-white" data-type="1">平台管理员</button>'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must add-site-container">'+
			            '<label class="col-sm-3 control-label">管理站点:</label>'+
			             	'<div class="col-sm-8">'+
								'<select class="form-control" id="add-sites" multiple=multiple>'+
								
								'</select>'+
			                '</div>'+
			            '</div>'+	            
			            '<div class="form-group">'+
			                '<div class="col-sm-offset-3 col-sm-8">'+
			                    '<span class="btn btn-primary" id="add-user">添加</span>'+
			                '</div>'+
			            '</div>'+
		        	'</form></div>',
		        	success:function(){
		        		$("#add-sites").select2({
						  ajax: {
						    url: "{{base_url('admin/Site/getSiteJson')}}",
						    type:'GET',
						    dataType: 'json',
						    delay: 250,
						    data: function (params) {
						      return {
						        "sitename": params.term, // search term
						      };
						    },
						    processResults: function (data, params) {
						      return {
						        results:data.data,
						      }
						    },
						    cache: false
						  },
						  escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
						  minimumInputLength: 1,
						  templateResult:function(re){
						  	if(re.loading) return "Loading..."
						  	return ('<strong>'+re.site_alias+'</strong> -'+re.site_domain)
						  },
						  templateSelection:function(re){
						  	return(re.site_alias)
						  }
						  
						});
		        	}
				});

        	})
        	$(document).on('click','.edit-btn',function(){
        		var $this = $(this);
        		var user = {};
        		$.ajax({
        			url: '{{base_url("admin/SiteUser/getUserInfo")}}',
        			type: 'POST',
        			dataType: 'json',
        			data: {uid: $this.attr('data-id')},
        			timeout:4000,
        			async:false
        		})
        		.done(function(data) {
	    			if(data.status==1){
        				user = (data.data)
        			}else{
        				common.ajaxError(data)
        			}
        		})
        		.fail(function() {
        		})
        		.always(function() {

        		});
        		var domHTML = '';
        		domHTML='<div class="ibox-content">'+
				  '<form class="form-horizontal">'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">邮箱:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" class="form-control" disabled="disabled readonly="readonly id="edit-email" placeholder="邮箱" value="'+(user.email||'')+'">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">密码:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" id="edit-password" class="form-control" placeholder="不修改请留空" value="">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group must">'+
			            '<label class="col-sm-3 control-label">真实姓名:</label>'+
			             	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" id="edit-realname" class="form-control" placeholder="真实姓名" value="'+user.realname+'">'+
			                '</div>'+
			            '</div>'+
			            '<div class="form-group">'+
			                '<label class="col-sm-3 control-label">用户类型:</label>'+
			               	'<div class="col-sm-8">'+
			                    '<input type="text" autocomplete="off" value="'+{"1":"平台管理员","2":"站点管理员","3":"站点用户"}[user.user_type]+'" id="edit-usertype" data-type="'+user.user_type+'" readonly="readonly" disabled="disabled" class="form-control" placeholder="用户类型">'+ 
			                '</div>'+
			            '</div>';
						if(user.user_type==2){
				            domHTML+='<div class="form-group must edit-site-container">'+
				            '<label class="col-sm-3 control-label">管理站点:</label>'+
				             	'<div class="col-sm-8">'+
									'<select class="form-control select2" id="edit-sites" multiple="multiple">';
							// for(var i in user.sites){
							// 	domHTML+='<option selected value="'+user.sites[i].id+'">'+user.sites[i].site_alias+'</option>';
							// 	console.log(user.sites[i].site_alias)
							// }

							domHTML+='</select>'+
				                	'</div>'+
					            	'</div>';	
			            }
            			domHTML+='<div class="form-group">'+
								'<div class="col-sm-offset-3 col-sm-8">'+
			                    '<span class="btn btn-primary" id="edit-user" data-id="'+user.id+'">修改</span>'+
				                '</div>'+
					            '</div>'+
					        	'</form></div>',

				layer.open({
				  type: 1,
				  closeBtn:2,
				  title:'修改用户',
				  shadeClose: true, //开启遮罩关闭
				  area: ['600px', 'auto'],
				  content:domHTML,
				  success:function(){
						$("#edit-sites").select2({
						  ajax: {
						    url: "{{base_url('admin/Site/getSiteJson')}}",
						    type:'GET',
						    dataType: 'json',
						    delay: 250,
						    data: function (params) {
						      return {
						        "sitename": params.term, // search term
						      };
						    },
						    processResults: function (data, params) {
						      return {
						        results:data.data,
						      }
						    },
						    cache: false
						  },
						  escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
						  minimumInputLength: 1,
						  templateResult:function(re){
						  	if(re.loading) return "Loading..."
						  	return ('<strong>'+re.site_alias+'</strong> -'+re.site_domain)
						  },
						  templateSelection:function(re){
						  	return(re.site_alias||re.text)
						  },
						});

					}
				});
						for(var i in user.sites){
						var $option = $('<option selected >'+user.sites[i].site_alias+'</option>').val(user.sites[i].id);
						$("#edit-sites").append($option).trigger('change');
						}
        	})
        	$(document).on('click',"#add-usertype .btn",function(){
        		if($(this).attr('data-type')==1){
        			$('.add-site-container').addClass('hide').find("#add-sites").val("");
        		}else{
        			$('.add-site-container').removeClass('hide')
        		}
        	})
        	$(document).on('click','.status-btn',function(e){
        		var $this = $(this);
        		var id = $(this).attr("data-id");
        		var index = $(this).parent().index()-1
        		if(id==""||id==null)return false;
        		$.ajax({
        			url: '{{base_url("admin/SiteUser/userEnable")}}',
        			type: 'POST',
        			dataType: 'json',
        			data: {'uid': id},
        			timeout:4000,
				   	beforeSend:function(){
				   		layer.load(2);
				   	}
        		})
        		.done(function(e) {
			   		if (e.status!=1) {
			   			common.ajaxError(e);
			   			return false;
			   		}
			   		layer.closeAll();
			   		$this.parent().parent().find('td').eq(index).html('<span for="" class="label label-'+{"1":"primary","0":"danger"}[e.data]+'">'+{"1":"Enable","0":"Disable"}[e.data]+'</span>')
			   		$this.removeClass('btn-danger btn-primary').addClass({"1":"btn-danger","0":"btn-primary"}[e.data])
			   		$this.attr('title',{"1":"禁用","0":"启用"}[e.data]).html('<i class="fa fa-'+{"1":"times","0":"check"}[e.data]+'"></i>');
			   		layer.tips(e.message,$this,{
			   			tips:[2,"#1ab394"]
			   		})

        		})
				.fail(function(e) {
					common.ajaxError(e)
				})
				.always(function() {
				   	layer.closeAll('loading');
				});
        	})
			$(document).on("click", "#add-user", function(){
			   var data = {
			   		realname:$("#add-realname").val(),
			   		email:$('#add-email').val(),
			   		user_type:$('#add-usertype .active').attr("data-type"),
			   		type:'add'
			   }
			   if(data.user_type!="1"){
			   		data.site = $('#add-sites').val()
			   }
			   $.ajax({
				   	url: '{{base_url("admin/SiteUser/addSiteUser")}}',
				   	type: 'POST',
				   	dataType: 'json',
				   	timeout:4000,
				   	data: {
				   		userInfo:JSON.stringify(data)
				   	},
				   	beforeSend:function(){
				   		layer.load(2);
				   	}
			   })
			   .done(function(e) {
			   		if (e.status!=1) {
			   			common.ajaxError(e);
			   			return false;
			   		}
			   		layer.closeAll();
			   		window.location.href = window.location.href;
			   		parent.layer.msg(e.message,{
			   			icon:1
			   		});
			   })
			   .fail(function(e) {
			   		common.ajaxError(e)
			   })
			   .always(function() {
				   	layer.closeAll('loading');
			   });
			   
			});
			$(document).on('click','#edit-user',function(){
				var data = {
					uid:$(this).attr('data-id'),
			   		realname:$("#edit-realname").val(),
			   		email:$('#edit-email').val(),
			   		password:$('#edit-password').val(),
			   		user_type:$('#edit-usertype').attr("data-type"),
			   		type:'edit'
			   	}
			   	if(data.user_type!=1){
			   		data.site = $('#edit-sites').val()
			   	}
				$.ajax({
				   	url: '{{base_url("admin/SiteUser/addSiteUser")}}',
				   	type: 'POST',
				   	dataType: 'json',
				   	timeout:4000,
				   	data: {
				   		userInfo:JSON.stringify(data)
				   	},
				   	beforeSend:function(){
				   		layer.load(2);
				   	}
			   })
			   .done(function(e) {
			   		if (e.status!=1) {
			   			common.ajaxError(e);
			   			return false;
			   		}
			   		layer.closeAll();
			   		window.location.href = window.location.href;
			   		
			   		parent.layer.msg(e.message,{
			   			icon:1
			   		});
			   })
			   .fail(function(e) {
			   		common.ajaxError(e)
			   })
			   .always(function() {
				   	layer.closeAll('loading');
			   });
			})

    	});



    </script>
{% endblock %}